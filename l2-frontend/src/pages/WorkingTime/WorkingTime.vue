<template>
  <div class="main">
    <div class="flex margin-bottom">
      <div class="filters department-width">
        <label>Подразделение</label>
        <Treeselect
          v-model="selectedDepartment"
          :options="departments"
          placeholder="Выберите подразделение"
        />
      </div>
      <div class="filters month-width">
        <label for="month">Месяц</label>
        <Treeselect
          v-model="selectedMonth"
          :options="months"
          placeholder="Выберите месяц"
        />
      </div>
      <div class="filters year-width">
        <label>Год</label>
        <Treeselect
          v-model="selectedYear"
          :options="years"
          placeholder="Выберите год"
        />
      </div>
      <div>{{ 'график на:'  }}</div>
    </div>
    <WorkingTimeTable
      v-if="workTimeDocument"
      :work-time-document-id="workTimeDocument"
      :year="selectedYear"
      :month="selectedMonth"
    />
    <div
      v-if="showCreateButton"
      class="create-document"
    >
      <button
        class="btn btn-blue-nb"
        @click="createWorkTimeDocument"
      >
        Создать график
      </button>
    </div>
  </div>
</template>

<script setup lang="ts">
import {
  computed, getCurrentInstance, onMounted, ref, watch,
} from 'vue';
import Treeselect from '@riophae/vue-treeselect';

import '@riophae/vue-treeselect/dist/vue-treeselect.css';
import 'vue-easytable/libs/theme-default/index.css';

import api from '@/api';
import { useStore } from '@/store';
import * as actions from '@/store/action-types';
import WorkingTimeTable from '@/pages/WorkingTime/WorkingTimeTable.vue';

const root = getCurrentInstance().proxy.$root;

const store = useStore();

const selectedMonth = ref(null);
const months = ref([
  { id: 1, label: 'Январь' },
  { id: 2, label: 'Февраль' },
  { id: 3, label: 'Март' },
  { id: 4, label: 'Апрель' },
  { id: 5, label: 'Май' },
  { id: 6, label: 'Июнь' },
  { id: 7, label: 'Июль' },
  { id: 8, label: 'Август' },
  { id: 9, label: 'Сентябрь' },
  { id: 10, label: 'Октябрь' },
  { id: 11, label: 'Ноябрь' },
  { id: 12, label: 'Декабрь' },
]);

const selectedYear = ref(2023);
const years = ref([]);

const currentDate = ref(new Date());
const getYears = (yearStart = 2023) => {
  let start = yearStart;
  currentDate.value.getFullYear();
  while (start <= currentDate.value.getFullYear()) {
    years.value.push({ id: start, label: String(start) });
    start++;
  }
};
const setCurrentDate = () => {
  selectedMonth.value = currentDate.value.getMonth() + 1;
  selectedYear.value = currentDate.value.getFullYear();
};

const selectedDepartment = ref(null);
const departments = ref([]);
const getDepartments = async () => {
  await store.dispatch(actions.INC_LOADING);
  const { result } = await api('/working-time/get-departments');
  await store.dispatch(actions.DEC_LOADING);
  departments.value = result;
};

const filtersIsFilled = computed(() => !!(selectedDepartment.value && selectedMonth.value && selectedYear.value));

const workTimeDocument = ref(null);

const showCreateButton = ref(false);
const getWorkTimeDocument = async () => {
  await store.dispatch(actions.INC_LOADING);
  const { result } = await api('/working-time/get-document', {
    month: selectedMonth.value,
    year: selectedYear.value,
    department: selectedDepartment.value,
  });
  await store.dispatch(actions.DEC_LOADING);
  workTimeDocument.value = result;
  if (!result) {
    showCreateButton.value = true;
  } else {
    showCreateButton.value = false;
  }
};

const createWorkTimeDocument = async () => {
  await store.dispatch(actions.INC_LOADING);
  const { ok } = await api('/working-time/create-document', {
    month: selectedMonth.value,
    year: selectedYear.value,
    department: selectedDepartment.value,
  });
  await store.dispatch(actions.DEC_LOADING);
  if (ok) {
    root.$emit('msg', 'ok', 'График создан');
    await getWorkTimeDocument();
  } else {
    root.$emit('msg', 'error', 'Ошибка');
  }
};

watch([selectedMonth, selectedYear, selectedDepartment], () => {
  if (filtersIsFilled.value) {
    getWorkTimeDocument();
  }
});

onMounted(() => {
  getDepartments();
  getYears();
  setCurrentDate();
});

</script>

<style scoped lang="scss">
.main {
  width: 100%;
  margin: 0 auto;
}
.flex {
  display: flex;
}
.four-col {
  display: grid;
  grid-template-columns: repeat(4, minmax(0, 1fr));
  margin-bottom: 5px;
}
.filters {
  margin: 0 10px;
}
.month-width {
  width: 130px;
}
.year-width {
  width: 100px;
}
.department-width {
  width: 490px;
}
.margin-bottom {
  margin-bottom: 5px;
}
.create-document {
  display: flex;
  align-items: center;
  justify-content: center;
}
</style>
